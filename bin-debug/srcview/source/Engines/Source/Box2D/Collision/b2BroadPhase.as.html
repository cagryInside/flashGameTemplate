<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>b2BroadPhase.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptComment">/*
* Copyright (c) 2006-2007 Erin Catto http://www.gphysics.com
*
* This software is provided 'as-is', without any express or implied
* warranty.  In no event will the authors be held liable for any damages
* arising from the use of this software.
* Permission is granted to anyone to use this software for any purpose,
* including commercial applications, and to alter it and redistribute it
* freely, subject to the following restrictions:
* 1. The origin of this software must not be misrepresented; you must not
* claim that you wrote the original software. If you use this software
* in a product, an acknowledgment in the product documentation would be
* appreciated but is not required.
* 2. Altered source versions must be plainly marked as such, and must not be
* misrepresented as being the original software.
* 3. This notice may not be removed or altered from any source distribution.
*/</span>

<span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Collision</span><span class="ActionScriptBracket/Brace">{</span>
    
    
<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Common</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;
<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Collision</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;
<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Common</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;

<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Common</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b2internal</span>;
<span class="ActionScriptReserved">use</span> <span class="ActionScriptReserved">namespace</span> <span class="ActionScriptDefault_Text">b2internal</span>;


<span class="ActionScriptComment">/*
This broad phase uses the Sweep and Prune algorithm as described in:
Collision Detection in Interactive 3D Environments by Gino van den Bergen
Also, some ideas, such as using integral values for fast compares comes from
Bullet (http:/www.bulletphysics.com).
*/</span>


<span class="ActionScriptComment">// Notes:
</span><span class="ActionScriptComment">// - we use bound arrays instead of linked lists for cache coherence.
</span><span class="ActionScriptComment">// - we use quantized integral values for fast compares.
</span><span class="ActionScriptComment">// - we use short indices rather than pointers to save memory.
</span><span class="ActionScriptComment">// - we use a stabbing count for fast overlap queries (less than order N).
</span><span class="ActionScriptComment">// - we also use a time stamp on each proxy to speed up the registration of
</span><span class="ActionScriptComment">//   overlap query results.
</span><span class="ActionScriptComment">// - where possible, we compare bound indices instead of values to reduce
</span><span class="ActionScriptComment">//   cache misses (TODO_ERIN).
</span><span class="ActionScriptComment">// - no broadphase is perfect and neither is this one: it is not great for huge
</span><span class="ActionScriptComment">//   worlds (use a multi-SAP instead), it is not great for large objects.
</span>
<span class="ActionScriptASDoc">/**
* @private
*/</span>
<span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">b2BroadPhase</span> <span class="ActionScriptReserved">implements</span> <span class="ActionScriptDefault_Text">IBroadPhase</span>
<span class="ActionScriptBracket/Brace">{</span>
<span class="ActionScriptComment">//public:
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">b2BroadPhase</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">worldAABB</span>:<span class="ActionScriptDefault_Text">b2AABB</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">//b2Settings.b2Assert(worldAABB.IsValid());
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span>;
        
        <span class="ActionScriptDefault_Text">m_pairManager</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Initialize</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptDefault_Text">m_worldAABB</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">worldAABB</span>;
        
        <span class="ActionScriptDefault_Text">m_proxyCount</span> <span class="ActionScriptOperator">=</span> 0;
        
        <span class="ActionScriptComment">// bounds array
</span>        <span class="ActionScriptDefault_Text">m_bounds</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//b2Vec2 d = worldAABB.upperBound - worldAABB.lowerBound;
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        
        <span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">dX</span>;
        <span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">dY</span>;
        
        <span class="ActionScriptDefault_Text">m_timeStamp</span> <span class="ActionScriptOperator">=</span> 1;
        <span class="ActionScriptDefault_Text">m_queryResultCount</span> <span class="ActionScriptOperator">=</span> 0;
    <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptComment">//~b2BroadPhase();
</span>    
    <span class="ActionScriptComment">// Use this to see if your proxy is in range. If it is not in range,
</span>    <span class="ActionScriptComment">// it should be destroyed. Otherwise you may get O(m^2) pairs, where m
</span>    <span class="ActionScriptComment">// is the number of proxies that are out of range.
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">InRange</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">aabb</span>:<span class="ActionScriptDefault_Text">b2AABB</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">//b2Vec2 d = b2Max(aabb.lowerBound - m_worldAABB.upperBound, m_worldAABB.lowerBound - aabb.upperBound);
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dX</span>:<span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dY</span>:<span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">d2X</span>:<span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">d2Y</span>:<span class="ActionScriptDefault_Text">Number</span>;
        
        <span class="ActionScriptDefault_Text">dX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">dY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptDefault_Text">dX</span> <span class="ActionScriptOperator">-=</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">dY</span> <span class="ActionScriptOperator">-=</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        
        <span class="ActionScriptDefault_Text">d2X</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">d2Y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptDefault_Text">d2X</span> <span class="ActionScriptOperator">-=</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">d2Y</span> <span class="ActionScriptOperator">-=</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        
        <span class="ActionScriptDefault_Text">dX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Max</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dX</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">d2X</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">dY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Max</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dY</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">d2Y</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Max</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dX</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">dY</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&lt;</span> 0.0;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptComment">// Create and destroy proxies. These call Flush first.
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">CreateProxy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">aabb</span>:<span class="ActionScriptDefault_Text">b2AABB</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">userData</span>:<span class="ActionScriptOperator">*</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptOperator">*</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">index</span>:<span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">j</span>:<span class="ActionScriptDefault_Text">int</span>;
        
        <span class="ActionScriptComment">//b2Settings.b2Assert(m_proxyCount &lt; b2_maxProxies);
</span>        <span class="ActionScriptComment">//b2Settings.b2Assert(m_freeProxy != b2Pair.b2_nullProxy);
</span>        
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">m_freeProxy</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// As all proxies are allocated, m_proxyCount == m_proxyPool.length
</span>            <span class="ActionScriptDefault_Text">m_freeProxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_proxyPool</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Proxy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">m_freeProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">next</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptDefault_Text">m_freeProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">timeStamp</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">m_freeProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">overlapCount</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2_invalid</span>;
            <span class="ActionScriptDefault_Text">m_freeProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">userData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_proxyCount</span> <span class="ActionScriptOperator">*</span> 2;
                <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptDefault_Text">proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_freeProxy</span>;
        <span class="ActionScriptDefault_Text">m_freeProxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">next</span>;
        
        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">overlapCount</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">userData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">userData</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">boundCount</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 2 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_proxyCount</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerValues</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperValues</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">ComputeBounds</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">axis</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerIndex</span>:<span class="ActionScriptDefault_Text">uint</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperIndex</span>:<span class="ActionScriptDefault_Text">uint</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerIndexOut</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperIndexOut</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">QueryAxis</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">boundCount</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">lowerIndex</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">upperIndex</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
            
            <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">splice</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">--</span>;
            <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">splice</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">--</span>;
            
            <span class="ActionScriptComment">// The upper index has increased because of the lower bound insertion.
</span>            <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">upperIndex</span>;
            
            <span class="ActionScriptComment">// Copy in the new bounds.
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tBound1</span>:<span class="ActionScriptDefault_Text">b2Bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tBound2</span>:<span class="ActionScriptDefault_Text">b2Bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span>;
            <span class="ActionScriptDefault_Text">tBound2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">tBound2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tBoundAS3</span>:<span class="ActionScriptDefault_Text">b2Bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndex</span> <span class="ActionScriptOperator">==</span> 0 <span class="ActionScriptOperator">?</span> 0 : <span class="ActionScriptDefault_Text">tBoundAS3</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span>;
            <span class="ActionScriptDefault_Text">tBoundAS3</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">tBound2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tBoundAS3</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span>;
            
            <span class="ActionScriptComment">// Adjust the stabbing count between the new bounds.
</span>            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndex</span>; <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">upperIndex</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">tBoundAS3</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">tBoundAS3</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">++</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// Adjust the all the affected bound indices.
</span>            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndex</span>; <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">boundCount</span> <span class="ActionScriptOperator">+</span> 2; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">tBound1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy2</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">proxy2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">index</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">proxy2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">index</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">m_proxyCount</span>;
        
        <span class="ActionScriptComment">//b2Settings.b2Assert(m_queryResultCount &lt; b2Settings.b2_maxProxies);
</span>        
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">m_queryResultCount</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//b2Settings.b2Assert(m_queryResults[i] &lt; b2_maxProxies);
</span>            <span class="ActionScriptComment">//b2Settings.b2Assert(m_proxyPool[m_queryResults[i]].IsValid());
</span>            
            <span class="ActionScriptDefault_Text">m_pairManager</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">AddBufferedPair</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_queryResults</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// Prepare for next query.
</span>        <span class="ActionScriptDefault_Text">m_queryResultCount</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptDefault_Text">IncrementTimeStamp</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">proxy</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">DestroyProxy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy_</span>:<span class="ActionScriptOperator">*</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy_</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Proxy</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tBound1</span>:<span class="ActionScriptDefault_Text">b2Bound</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tBound2</span>:<span class="ActionScriptDefault_Text">b2Bound</span>;
        
        <span class="ActionScriptComment">//b2Settings.b2Assert(proxy.IsValid());
</span>        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">boundCount</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 2 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_proxyCount</span>;
        
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">axis</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerIndex</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperIndex</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">tBound1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerValue</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>;
            <span class="ActionScriptDefault_Text">tBound2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperValue</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tBound2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>;
            
            <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">splice</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">splice</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tBound2</span><span class="ActionScriptBracket/Brace">)</span>;
            
            
            <span class="ActionScriptComment">// Fix bound indices.
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tEnd</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">boundCount</span> <span class="ActionScriptOperator">-</span> 2;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">index</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndex</span>; <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">tEnd</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">tBound1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy2</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">proxy2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">index</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">proxy2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">index</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// Fix stabbing count.
</span>            <span class="ActionScriptDefault_Text">tEnd</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperIndex</span> <span class="ActionScriptOperator">-</span> 1;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">index2</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndex</span>; <span class="ActionScriptDefault_Text">index2</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">tEnd</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">index2</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">tBound1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index2</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">tBound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">--</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// Query for pairs to be removed. lowerIndex and upperIndex are not needed.
</span>            <span class="ActionScriptComment">// make lowerIndex and upper output using an array and do this for others if compiler doesn't pick them up
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ignore</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">QueryAxis</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ignore</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">ignore</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lowerValue</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValue</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">boundCount</span> <span class="ActionScriptOperator">-</span> 2<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//b2Settings.b2Assert(m_queryResultCount &lt; b2Settings.b2_maxProxies);
</span>        
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">m_queryResultCount</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//b2Settings.b2Assert(m_proxyPool[m_queryResults[i]].IsValid());
</span>            
            <span class="ActionScriptDefault_Text">m_pairManager</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">RemoveBufferedPair</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_queryResults</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// Prepare for next query.
</span>        <span class="ActionScriptDefault_Text">m_queryResultCount</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptDefault_Text">IncrementTimeStamp</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">// Return the proxy to the pool.
</span>        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">userData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">overlapCount</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2_invalid</span>;
        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2_invalid</span>;
        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2_invalid</span>;
        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2_invalid</span>;
        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2_invalid</span>;
        
        <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">next</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_freeProxy</span>;
        <span class="ActionScriptDefault_Text">m_freeProxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span>;
        <span class="ActionScriptOperator">--</span><span class="ActionScriptDefault_Text">m_proxyCount</span>;
    <span class="ActionScriptBracket/Brace">}</span>


    <span class="ActionScriptComment">// Call MoveProxy as many times as you like, then when you are done
</span>    <span class="ActionScriptComment">// call Commit to finalized the proxy pairs (for your time step).
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">MoveProxy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy_</span>:<span class="ActionScriptOperator">*</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">aabb</span>:<span class="ActionScriptDefault_Text">b2AABB</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">displacement</span>:<span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy_</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Proxy</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">as3arr</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">as3int</span>:<span class="ActionScriptDefault_Text">int</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">axis</span>:<span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">index</span>:<span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bound</span>:<span class="ActionScriptDefault_Text">b2Bound</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">prevBound</span>:<span class="ActionScriptDefault_Text">b2Bound</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">nextBound</span>:<span class="ActionScriptDefault_Text">b2Bound</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">nextProxyId</span>:<span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">nextProxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span>;
        
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//b2Settings.b2Assert(false);
</span>            <span class="ActionScriptReserved">return</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsValid</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//b2Settings.b2Assert(false);
</span>            <span class="ActionScriptReserved">return</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">boundCount</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 2 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_proxyCount</span>;
        
        <span class="ActionScriptComment">// Get new bound values
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">newValues</span>:<span class="ActionScriptDefault_Text">b2BoundValues</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2BoundValues</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">ComputeBounds</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">newValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">newValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">// Get old bound values
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">oldValues</span>:<span class="ActionScriptDefault_Text">b2BoundValues</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2BoundValues</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">oldValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>;
            <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">oldValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerIndex</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperIndex</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerValue</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperValue</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            
            <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">deltaLower</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerValue</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>;
            <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerValue</span>;
            
            <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">deltaUpper</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperValue</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>;
            <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperValue</span>;
            
            <span class="ActionScriptComment">//
</span>            <span class="ActionScriptComment">// Expanding adds overlaps
</span>            <span class="ActionScriptComment">//
</span>            
            <span class="ActionScriptComment">// Should we move the lower bound down?
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">deltaLower</span> <span class="ActionScriptOperator">&lt;</span> 0<span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndex</span>;
                <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&gt;</span> 0 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">lowerValue</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">prevBound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span>;
                    
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">prevProxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">prevBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                    
                    <span class="ActionScriptDefault_Text">prevBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">++</span>;
                    
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">prevBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsUpper</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">TestOverlapBound</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">newValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">prevProxy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">m_pairManager</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">AddBufferedPair</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">prevProxy</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                        
                        <span class="ActionScriptComment">//prevProxy.upperBounds[axis]++;
</span>                        <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">prevProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span>;
                        <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                        <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">++</span>;
                        <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                        
                        <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">++</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptReserved">else</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptComment">//prevProxy.lowerBounds[axis]++;
</span>                        <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">prevProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span>;
                        <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                        <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">++</span>;
                        <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                        
                        <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">--</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    
                    <span class="ActionScriptComment">//proxy.lowerBounds[axis]--;
</span>                    <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span>;
                    <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">--</span>;
                    <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                    
                    <span class="ActionScriptComment">// swap
</span>                    <span class="ActionScriptComment">//var temp:b2Bound = bound;
</span>                    <span class="ActionScriptComment">//bound = prevEdge;
</span>                    <span class="ActionScriptComment">//prevEdge = temp;
</span>                    <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Swap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">prevBound</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptComment">//b2Math.Swap(bound, prevEdge);
</span>                    <span class="ActionScriptOperator">--</span><span class="ActionScriptDefault_Text">index</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// Should we move the upper bound up?
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">deltaUpper</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperIndex</span>;
                <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">boundCount</span><span class="ActionScriptOperator">-</span>1 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">upperValue</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span> <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">nextBound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span> <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">+</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">nextProxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">nextBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                    
                    <span class="ActionScriptDefault_Text">nextBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">++</span>;
                    
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">nextBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">TestOverlapBound</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">newValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">nextProxy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">m_pairManager</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">AddBufferedPair</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">nextProxy</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                        
                        <span class="ActionScriptComment">//nextProxy.lowerBounds[axis]--;
</span>                        <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">nextProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span>;
                        <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                        <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">--</span>;
                        <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                        
                        <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">++</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptReserved">else</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptComment">//nextProxy.upperBounds[axis]--;
</span>                        <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">nextProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span>;
                        <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                        <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">--</span>;
                        <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                        
                        <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">--</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    
                    <span class="ActionScriptComment">//proxy.upperBounds[axis]++;
</span>                    <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span>;
                    <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">++</span>;
                    <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                    
                    <span class="ActionScriptComment">// swap
</span>                    <span class="ActionScriptComment">//var temp:b2Bound = bound;
</span>                    <span class="ActionScriptComment">//bound = nextEdge;
</span>                    <span class="ActionScriptComment">//nextEdge = temp;
</span>                    <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Swap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">nextBound</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptComment">//b2Math.Swap(bound, nextEdge);
</span>                    <span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">++</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">//
</span>            <span class="ActionScriptComment">// Shrinking removes overlaps
</span>            <span class="ActionScriptComment">//
</span>            
            <span class="ActionScriptComment">// Should we move the lower bound up?
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">deltaLower</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndex</span>;
                <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">boundCount</span><span class="ActionScriptOperator">-</span>1 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">lowerValue</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span> <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">nextBound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span> <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">+</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">]</span>;
                    
                    <span class="ActionScriptDefault_Text">nextProxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">nextBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                    
                    <span class="ActionScriptDefault_Text">nextBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">--</span>;
                    
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">nextBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsUpper</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">TestOverlapBound</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">oldValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">nextProxy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">m_pairManager</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">RemoveBufferedPair</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">nextProxy</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                        
                        <span class="ActionScriptComment">//nextProxy.upperBounds[axis]--;
</span>                        <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">nextProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span>;
                        <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                        <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">--</span>;
                        <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                        
                        <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">--</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptReserved">else</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptComment">//nextProxy.lowerBounds[axis]--;
</span>                        <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">nextProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span>;
                        <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                        <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">--</span>;
                        <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                        
                        <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">++</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    
                    <span class="ActionScriptComment">//proxy.lowerBounds[axis]++;
</span>                    <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span>;
                    <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">++</span>;
                    <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                    
                    <span class="ActionScriptComment">// swap
</span>                    <span class="ActionScriptComment">//var temp:b2Bound = bound;
</span>                    <span class="ActionScriptComment">//bound = nextEdge;
</span>                    <span class="ActionScriptComment">//nextEdge = temp;
</span>                    <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Swap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">nextBound</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptComment">//b2Math.Swap(bound, nextEdge);
</span>                    <span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">++</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// Should we move the upper bound down?
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">deltaUpper</span> <span class="ActionScriptOperator">&lt;</span> 0<span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperIndex</span>;
                <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&gt;</span> 0 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">upperValue</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">prevBound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span>;
                    
                    <span class="ActionScriptDefault_Text">prevProxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">prevBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                    
                    <span class="ActionScriptDefault_Text">prevBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">--</span>;
                    
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">prevBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">TestOverlapBound</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">oldValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">prevProxy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">m_pairManager</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">RemoveBufferedPair</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">prevProxy</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                        
                        <span class="ActionScriptComment">//prevProxy.lowerBounds[axis]++;
</span>                        <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">prevProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span>;
                        <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                        <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">++</span>;
                        <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                        
                        <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">--</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptReserved">else</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptComment">//prevProxy.upperBounds[axis]++;
</span>                        <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">prevProxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span>;
                        <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                        <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">++</span>;
                        <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                        
                        <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">++</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    
                    <span class="ActionScriptComment">//proxy.upperBounds[axis]--;
</span>                    <span class="ActionScriptDefault_Text">as3arr</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span>;
                    <span class="ActionScriptDefault_Text">as3int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">as3int</span><span class="ActionScriptOperator">--</span>;
                    <span class="ActionScriptDefault_Text">as3arr</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">as3int</span>;
                    
                    <span class="ActionScriptComment">// swap
</span>                    <span class="ActionScriptComment">//var temp:b2Bound = bound;
</span>                    <span class="ActionScriptComment">//bound = prevEdge;
</span>                    <span class="ActionScriptComment">//prevEdge = temp;
</span>                    <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Swap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">prevBound</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptComment">//b2Math.Swap(bound, prevEdge);
</span>                    <span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">--</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">UpdatePairs</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">callback</span>:<span class="ActionScriptDefault_Text">Function</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptDefault_Text">m_pairManager</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Commit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">callback</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">TestOverlap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxyA</span>:<span class="ActionScriptOperator">*</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">proxyB</span>:<span class="ActionScriptOperator">*</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Boolean</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxyA_</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxyA</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Proxy</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxyB_</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxyB</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Proxy</span>;
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">proxyA_</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">proxyB_</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">proxyB_</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">proxyA_</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">proxyA_</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">proxyB_</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">proxyB_</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">proxyA_</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptASDoc">/**
     * Get user data from a proxy. Returns null if the proxy is invalid.
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetUserData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptOperator">*</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptOperator">*</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Proxy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">userData</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptASDoc">/**
     * Get the AABB for a proxy.
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetFatAABB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy_</span>:<span class="ActionScriptOperator">*</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">b2AABB</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">aabb</span>:<span class="ActionScriptDefault_Text">b2AABB</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2AABB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy_</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Proxy</span>;
        <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span>  <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>  <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span>  <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>  <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span>  <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>  <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span>  <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span>  <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">aabb</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptASDoc">/**
     * Get the number of proxies.
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetProxyCount</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">int</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">m_proxyCount</span>;
    <span class="ActionScriptBracket/Brace">}</span>
        
    
    <span class="ActionScriptASDoc">/**
     * Query an AABB for overlapping proxies. The callback class
     * is called for each proxy that overlaps the supplied AABB.
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">Query</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">callback</span>:<span class="ActionScriptDefault_Text">Function</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">aabb</span>:<span class="ActionScriptDefault_Text">b2AABB</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerValues</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperValues</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">ComputeBounds</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerIndex</span>:<span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperIndex</span>:<span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerIndexOut</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperIndexOut</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">QueryAxis</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">QueryAxis</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">//b2Settings.b2Assert(m_queryResultCount &lt; b2Settings.b2_maxProxies);
</span>        
        <span class="ActionScriptComment">// TODO: Don't be lazy, transform QueryAxis to directly call callback
</span>        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">m_queryResultCount</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span>  <span class="ActionScriptDefault_Text">m_queryResults</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptComment">//b2Settings.b2Assert(proxy.IsValid());
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">callback</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">break</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// Prepare for next query.
</span>        <span class="ActionScriptDefault_Text">m_queryResultCount</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptDefault_Text">IncrementTimeStamp</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">Validate</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">pair</span>:<span class="ActionScriptDefault_Text">b2Pair</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy1</span>:<span class="ActionScriptDefault_Text">b2Proxy</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy2</span>:<span class="ActionScriptDefault_Text">b2Proxy</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">overlap</span>:<span class="ActionScriptDefault_Text">Boolean</span>;
        
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">axis</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">boundCount</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 2 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_proxyCount</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stabbingCount</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 0;
            
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">boundCount</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bound</span>:<span class="ActionScriptDefault_Text">b2Bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptComment">//b2Settings.b2Assert(i == 0 || bounds[i-1].value &lt;= bound-&gt;value);
</span>                <span class="ActionScriptComment">//b2Settings.b2Assert(bound-&gt;proxyId != b2_nullProxy);
</span>                <span class="ActionScriptComment">//b2Settings.b2Assert(m_proxyPool[bound-&gt;proxyId].IsValid());
</span>                
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">//b2Settings.b2Assert(m_proxyPool[bound.proxyId].lowerBounds[axis] == i);
</span>                    <span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">++</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">//b2Settings.b2Assert(m_proxyPool[bound.proxyId].upperBounds[axis] == i);
</span>                    <span class="ActionScriptDefault_Text">stabbingCount</span><span class="ActionScriptOperator">--</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                
                <span class="ActionScriptComment">//b2Settings.b2Assert(bound.stabbingCount == stabbingCount);
</span>            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">Rebalance</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">iterations</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">// Do nothing
</span>    <span class="ActionScriptBracket/Brace">}</span>

    
    <span class="ActionScriptASDoc">/**
     * @inheritDoc
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">RayCast</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">callback</span>:<span class="ActionScriptDefault_Text">Function</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">input</span>:<span class="ActionScriptDefault_Text">b2RayCastInput</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">subInput</span>:<span class="ActionScriptDefault_Text">b2RayCastInput</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span>  <span class="ActionScriptDefault_Text">b2RayCastInput</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SetV</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p1</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SetV</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p2</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span>;
        
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dx</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dy</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sx</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">dx</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">MIN_VALUE</span> <span class="ActionScriptOperator">?</span> <span class="ActionScriptOperator">-</span>1 : <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dx</span><span class="ActionScriptOperator">&gt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">MIN_VALUE</span> <span class="ActionScriptOperator">?</span> 1 : 0<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sy</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">dy</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">MIN_VALUE</span> <span class="ActionScriptOperator">?</span> <span class="ActionScriptOperator">-</span>1 : <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dy</span><span class="ActionScriptOperator">&gt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">MIN_VALUE</span> <span class="ActionScriptOperator">?</span> 1 : 0<span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">//b2Settings.b2Assert(sx!=0||sy!=0);
</span>        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">p1x</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">p1y</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">input</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">p1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">startValues</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">startValues2</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">startValues</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p1x</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">startValues</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p1y</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">startValues2</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">startValues</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">+</span>1;
        <span class="ActionScriptDefault_Text">startValues2</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">startValues</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">+</span>1;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">startIndices</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xIndex</span>:<span class="ActionScriptDefault_Text">int</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">yIndex</span>:<span class="ActionScriptDefault_Text">int</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span>;
        
        
        <span class="ActionScriptComment">//First deal with all the proxies that contain segment.p1
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerIndex</span>:<span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperIndex</span>:<span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerIndexOut</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>; 
        <span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndex</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperIndexOut</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">upperIndex</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">QueryAxis</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">startValues</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">startValues2</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptOperator">&gt;=</span>0<span class="ActionScriptBracket/Brace">)</span>    <span class="ActionScriptDefault_Text">xIndex</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">-</span>1;
        <span class="ActionScriptReserved">else</span>        <span class="ActionScriptDefault_Text">xIndex</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptDefault_Text">QueryAxis</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">startValues</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">startValues2</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptOperator">&gt;=</span>0<span class="ActionScriptBracket/Brace">)</span>    <span class="ActionScriptDefault_Text">yIndex</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperIndexOut</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">-</span>1;
        <span class="ActionScriptReserved">else</span>        <span class="ActionScriptDefault_Text">yIndex</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerIndexOut</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
            
        <span class="ActionScriptComment">// Callback for starting proxies:
</span>        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">m_queryResultCount</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">callback</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_queryResults</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//Now work through the rest of the segment
</span>        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span>;; <span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xProgress</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">yProgress</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptComment">//Move on to next bound
</span>            <span class="ActionScriptDefault_Text">xIndex</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">sx</span> <span class="ActionScriptOperator">&gt;=</span> 0<span class="ActionScriptOperator">?</span>1: <span class="ActionScriptOperator">-</span>1;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">&lt;</span>0<span class="ActionScriptOperator">||</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">&gt;=</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptOperator">*</span>2<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">break</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptOperator">!=</span>0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">xProgress</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">p1x</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">dx</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">//Move on to next bound
</span>            <span class="ActionScriptDefault_Text">yIndex</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">sy</span> <span class="ActionScriptOperator">&gt;=</span> 0<span class="ActionScriptOperator">?</span>1: <span class="ActionScriptOperator">-</span>1;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">&lt;</span>0<span class="ActionScriptOperator">||</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">&gt;=</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptOperator">*</span>2<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">break</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptOperator">!=</span>0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">yProgress</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">p1y</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">dy</span>;    
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span>;; <span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>    
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptOperator">==</span>0<span class="ActionScriptOperator">||</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptOperator">!=</span>0<span class="ActionScriptOperator">&amp;&amp;</span><span class="ActionScriptDefault_Text">xProgress</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">yProgress</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xProgress</span><span class="ActionScriptOperator">&gt;</span><span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span><span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptReserved">break</span>;
                    
                    <span class="ActionScriptComment">//Check that we are entering a proxy, not leaving
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptOperator">&gt;</span>0<span class="ActionScriptOperator">?</span><span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsUpper</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptComment">//Check the other axis of the proxy
</span>                        <span class="ActionScriptDefault_Text">proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptOperator">&gt;=</span>0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">&lt;=</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptOperator">&amp;&amp;</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">&gt;=</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                                <span class="ActionScriptComment">//Add the proxy
</span>                                <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">callback</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptBracket/Brace">}</span>
                        <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptReserved">else</span><span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">&lt;=</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">&amp;&amp;</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">&gt;=</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                                <span class="ActionScriptComment">//Add the proxy
</span>                                <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">callback</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptBracket/Brace">}</span>
                        <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptBracket/Brace">}</span>
                    
                    <span class="ActionScriptComment">//Early out
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span><span class="ActionScriptOperator">==</span>0<span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptReserved">break</span>;
                    
                    <span class="ActionScriptComment">//Move on to the next bound
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptOperator">&gt;</span>0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">++</span>;
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">==</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptOperator">*</span>2<span class="ActionScriptBracket/Brace">)</span>
                            <span class="ActionScriptReserved">break</span>;
                    <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptReserved">else</span><span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">--</span>;
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">&lt;</span>0<span class="ActionScriptBracket/Brace">)</span>
                            <span class="ActionScriptReserved">break</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptDefault_Text">xProgress</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">p1x</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">dx</span>;
                <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptReserved">else</span><span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">yProgress</span><span class="ActionScriptOperator">&gt;</span><span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span><span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptReserved">break</span>;
                    
                    <span class="ActionScriptComment">//Check that we are entering a proxy, not leaving
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptOperator">&gt;</span>0<span class="ActionScriptOperator">?</span><span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsUpper</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptComment">//Check the other axis of the proxy
</span>                        <span class="ActionScriptDefault_Text">proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sx</span><span class="ActionScriptOperator">&gt;=</span>0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">&lt;=</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptOperator">&amp;&amp;</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">&gt;=</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                                <span class="ActionScriptComment">//Add the proxy
</span>                                <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">callback</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptBracket/Brace">}</span>
                        <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptReserved">else</span><span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">&lt;=</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">&amp;&amp;</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">&gt;=</span><span class="ActionScriptDefault_Text">xIndex</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                                <span class="ActionScriptComment">//Add the proxy
</span>                                <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">callback</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptBracket/Brace">}</span>
                        <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptBracket/Brace">}</span>
                    
                    <span class="ActionScriptComment">//Early out
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">subInput</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxFraction</span><span class="ActionScriptOperator">==</span>0<span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptReserved">break</span>;
                    
                    <span class="ActionScriptComment">//Move on to the next bound
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sy</span><span class="ActionScriptOperator">&gt;</span>0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">++</span>;
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">==</span><span class="ActionScriptDefault_Text">m_proxyCount</span><span class="ActionScriptOperator">*</span>2<span class="ActionScriptBracket/Brace">)</span>
                            <span class="ActionScriptReserved">break</span>;
                    <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptReserved">else</span><span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">--</span>;
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptOperator">&lt;</span>0<span class="ActionScriptBracket/Brace">)</span>
                            <span class="ActionScriptReserved">break</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptDefault_Text">yProgress</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">yIndex</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">p1y</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">dy</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">break</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// Prepare for next query.
</span>        <span class="ActionScriptDefault_Text">m_queryResultCount</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptDefault_Text">IncrementTimeStamp</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptReserved">return</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
<span class="ActionScriptComment">//private:
</span>    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">ComputeBounds</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerValues</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValues</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">aabb</span>:<span class="ActionScriptDefault_Text">b2AABB</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">//b2Settings.b2Assert(aabb.upperBound.x &gt;= aabb.lowerBound.x);
</span>        <span class="ActionScriptComment">//b2Settings.b2Assert(aabb.upperBound.y &gt;= aabb.lowerBound.y);
</span>        
        <span class="ActionScriptComment">//var minVertex:b2Vec2 = b2Math.ClampV(aabb.minVertex, m_worldAABB.minVertex, m_worldAABB.maxVertex);
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">minVertexX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">minVertexY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptDefault_Text">minVertexX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Min</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minVertexX</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">minVertexY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Min</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minVertexY</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">minVertexX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Max</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minVertexX</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">minVertexY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Max</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minVertexY</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">//var maxVertex:b2Vec2 = b2Math.ClampV(aabb.maxVertex, m_worldAABB.minVertex, m_worldAABB.maxVertex);
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">maxVertexX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">maxVertexY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">aabb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptDefault_Text">maxVertexX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Min</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxVertexX</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">maxVertexY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Min</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxVertexY</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">maxVertexX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Max</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxVertexX</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">maxVertexY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Max</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxVertexY</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">// Bump lower bounds downs and upper bounds up. This ensures correct sorting of
</span>        <span class="ActionScriptComment">// lower/upper bounds that would have equal values.
</span>        <span class="ActionScriptComment">// TODO_ERIN implement fast float to uint16 conversion.
</span>        <span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minVertexX</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxVertexX</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">&amp;</span> 0x0000ffff<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">|</span> 1;
        
        <span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minVertexY</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_quantizationFactor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxVertexY</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_worldAABB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">&amp;</span> 0x0000ffff<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">|</span> 1;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptComment">// This one is only used for validation.
</span>    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">TestOverlapValidate</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p1</span>:<span class="ActionScriptDefault_Text">b2Proxy</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">p2</span>:<span class="ActionScriptDefault_Text">b2Proxy</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptBracket/Brace">{</span>
        
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">axis</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            
            <span class="ActionScriptComment">//b2Settings.b2Assert(p1.lowerBounds[axis] &lt; 2 * m_proxyCount);
</span>            <span class="ActionScriptComment">//b2Settings.b2Assert(p1.upperBounds[axis] &lt; 2 * m_proxyCount);
</span>            <span class="ActionScriptComment">//b2Settings.b2Assert(p2.lowerBounds[axis] &lt; 2 * m_proxyCount);
</span>            <span class="ActionScriptComment">//b2Settings.b2Assert(p2.upperBounds[axis] &lt; 2 * m_proxyCount);
</span>            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bound1</span>:<span class="ActionScriptDefault_Text">b2Bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">p1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bound2</span>:<span class="ActionScriptDefault_Text">b2Bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">p2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">bound2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            
            <span class="ActionScriptDefault_Text">bound1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">p1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptDefault_Text">bound2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">p2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">bound2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">TestOverlapBound</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b</span>:<span class="ActionScriptDefault_Text">b2BoundValues</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">p</span>:<span class="ActionScriptDefault_Text">b2Proxy</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Boolean</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">axis</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">axis</span> <span class="ActionScriptOperator">&lt;</span> 2; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span>;
            
            <span class="ActionScriptComment">//b2Settings.b2Assert(p.lowerBounds[axis] &lt; 2 * m_proxyCount);
</span>            <span class="ActionScriptComment">//b2Settings.b2Assert(p.upperBounds[axis] &lt; 2 * m_proxyCount);
</span>            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bound</span>:<span class="ActionScriptDefault_Text">b2Bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
            
            <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lowerBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperValues</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">QueryAxis</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerQueryOut</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperQueryOut</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lowerValue</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValue</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">boundCount</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">axis</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span><span class="ActionScriptBracket/Brace">{</span>
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lowerQuery</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">BinarySearch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">boundCount</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lowerValue</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">upperQuery</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">BinarySearch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">boundCount</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">upperValue</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bound</span>: <span class="ActionScriptDefault_Text">b2Bound</span>;
        
        <span class="ActionScriptComment">// Easy case: lowerQuery &lt;= lowerIndex(i) &lt; upperQuery
</span>        <span class="ActionScriptComment">// Solution: search query range for min bounds.
</span>        <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">j</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerQuery</span>; <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">upperQuery</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">IncrementOverlapCount</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// Hard case: lowerIndex(i) &lt; lowerQuery &lt; upperIndex(i)
</span>        <span class="ActionScriptComment">// Solution: use the stabbing count to search down the bound array.
</span>        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerQuery</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerQuery</span> <span class="ActionScriptOperator">-</span> 1;
            <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">s</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stabbingCount</span>;
            
            <span class="ActionScriptComment">// Find the s overlaps.
</span>            <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">s</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">//b2Settings.b2Assert(i &gt;= 0);
</span>                <span class="ActionScriptDefault_Text">bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsLower</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span>;
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lowerQuery</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">upperBounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">axis</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">IncrementOverlapCount</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptOperator">--</span><span class="ActionScriptDefault_Text">s</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptOperator">--</span><span class="ActionScriptDefault_Text">i</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptDefault_Text">lowerQueryOut</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lowerQuery</span>;
        <span class="ActionScriptDefault_Text">upperQueryOut</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">upperQuery</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">IncrementOverlapCount</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">timeStamp</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">m_timeStamp</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">timeStamp</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_timeStamp</span>;
            <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">overlapCount</span> <span class="ActionScriptOperator">=</span> 1;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">else</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">proxy</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">overlapCount</span> <span class="ActionScriptOperator">=</span> 2;
            <span class="ActionScriptComment">//b2Settings.b2Assert(m_queryResultCount &lt; b2Settings.b2_maxProxies);
</span>            <span class="ActionScriptDefault_Text">m_queryResults</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">m_queryResultCount</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">proxy</span>;
            <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">m_queryResultCount</span>;
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">IncrementTimeStamp</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_timeStamp</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">m_proxyPool</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_proxyPool</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">b2Proxy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">timeStamp</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">m_timeStamp</span> <span class="ActionScriptOperator">=</span> 1;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">else</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">m_timeStamp</span>;
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_pairManager</span>:<span class="ActionScriptDefault_Text">b2PairManager</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2PairManager</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;

    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_proxyPool</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_freeProxy</span>:<span class="ActionScriptDefault_Text">b2Proxy</span>;

    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptBracket/Brace">&gt;</span> ;

    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_querySortKeys</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_queryResults</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_queryResultCount</span>:<span class="ActionScriptDefault_Text">int</span>;

    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_worldAABB</span>:<span class="ActionScriptDefault_Text">b2AABB</span>;
    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_quantizationFactor</span>:<span class="ActionScriptDefault_Text">b2Vec2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_proxyCount</span>:<span class="ActionScriptDefault_Text">int</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_timeStamp</span>:<span class="ActionScriptDefault_Text">uint</span>;

    <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">s_validate</span>:<span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
    
    <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">b2_invalid</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span>;
    <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">b2_nullEdge</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b2Settings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">USHRT_MAX</span>;


    <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">BinarySearch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bounds</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">b2Bound</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">count</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">value</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">uint</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">low</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">high</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">count</span> <span class="ActionScriptOperator">-</span> 1;
        <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">low</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">high</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">mid</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">low</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">high</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 2<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bound</span>:<span class="ActionScriptDefault_Text">b2Bound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bounds</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">mid</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">value</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">high</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">mid</span> <span class="ActionScriptOperator">-</span> 1;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">value</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">low</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">mid</span> <span class="ActionScriptOperator">+</span> 1;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">else</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mid</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">low</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    
<span class="ActionScriptBracket/Brace">}</span>;
<span class="ActionScriptBracket/Brace">}</span>
</pre></body>
</html>
