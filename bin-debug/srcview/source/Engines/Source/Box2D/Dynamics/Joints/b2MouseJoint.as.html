<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>b2MouseJoint.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptComment">/*
* Copyright (c) 2006-2007 Erin Catto http://www.gphysics.com
*
* This software is provided 'as-is', without any express or implied
* warranty.  In no event will the authors be held liable for any damages
* arising from the use of this software.
* Permission is granted to anyone to use this software for any purpose,
* including commercial applications, and to alter it and redistribute it
* freely, subject to the following restrictions:
* 1. The origin of this software must not be misrepresented; you must not
* claim that you wrote the original software. If you use this software
* in a product, an acknowledgment in the product documentation would be
* appreciated but is not required.
* 2. Altered source versions must be plainly marked as such, and must not be
* misrepresented as being the original software.
* 3. This notice may not be removed or altered from any source distribution.
*/</span>

<span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Dynamics</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Joints</span><span class="ActionScriptBracket/Brace">{</span>


<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Common</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;
<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Common</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;
<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Dynamics</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;

<span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">Box2D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Common</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b2internal</span>;
<span class="ActionScriptReserved">use</span> <span class="ActionScriptReserved">namespace</span> <span class="ActionScriptDefault_Text">b2internal</span>;


<span class="ActionScriptComment">// p = attached point, m = mouse point
</span><span class="ActionScriptComment">// C = p - m
</span><span class="ActionScriptComment">// Cdot = v
</span><span class="ActionScriptComment">//      = v + cross(w, r)
</span><span class="ActionScriptComment">// J = [I r_skew]
</span><span class="ActionScriptComment">// Identity used:
</span><span class="ActionScriptComment">// w k % (rx i + ry j) = w * (-ry i + rx j)
</span>
<span class="ActionScriptASDoc">/**
* A mouse joint is used to make a point on a body track a
* specified world point. This a soft constraint with a maximum
* force. This allows the constraint to stretch and without
* applying huge forces.
* Note: this joint is not fully documented as it is intended primarily
* for the testbed. See that for more instructions.
* @see b2MouseJointDef
*/</span>

<span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">b2MouseJoint</span> <span class="ActionScriptReserved">extends</span> <span class="ActionScriptDefault_Text">b2Joint</span>
<span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptASDoc">/** @inheritDoc */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetAnchorA</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">m_target</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptASDoc">/** @inheritDoc */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetAnchorB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">m_bodyB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">GetWorldPoint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_localAnchor</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptASDoc">/** @inheritDoc */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetReactionForce</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">inv_dt</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">b2Vec2</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">inv_dt</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">inv_dt</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptASDoc">/** @inheritDoc */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetReactionTorque</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">inv_dt</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Number</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> 0.0;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetTarget</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">b2Vec2</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">m_target</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptASDoc">/**
     * Use this to update the target point.
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">SetTarget</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">target</span>:<span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_bodyB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IsAwake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">m_bodyB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SetAwake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptDefault_Text">m_target</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">target</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptComment">/// Get the maximum force in Newtons.
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetMaxForce</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Number</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">m_maxForce</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptComment">/// Set the maximum force in Newtons.
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">SetMaxForce</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxForce</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptDefault_Text">m_maxForce</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">maxForce</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptComment">/// Get frequency in Hz
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetFrequency</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Number</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">m_frequencyHz</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptComment">/// Set the frequency in Hz
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">SetFrequency</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">hz</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptDefault_Text">m_frequencyHz</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">hz</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptComment">/// Get damping ratio
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">GetDampingRatio</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Number</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">m_dampingRatio</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptComment">/// Set damping ratio
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">SetDampingRatio</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ratio</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptDefault_Text">m_dampingRatio</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">ratio</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptComment">//--------------- Internals Below -------------------
</span>
    <span class="ActionScriptASDoc">/** @private */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">b2MouseJoint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">def</span>:<span class="ActionScriptDefault_Text">b2MouseJointDef</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">super</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">def</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">//b2Settings.b2Assert(def.target.IsValid());
</span>        <span class="ActionScriptComment">//b2Settings.b2Assert(b2Math.b2IsValid(def.maxForce) &amp;&amp; def.maxForce &gt; 0.0);
</span>        <span class="ActionScriptComment">//b2Settings.b2Assert(b2Math.b2IsValid(def.frequencyHz) &amp;&amp; def.frequencyHz &gt; 0.0);
</span>        <span class="ActionScriptComment">//b2Settings.b2Assert(b2Math.b2IsValid(def.dampingRatio) &amp;&amp; def.dampingRatio &gt; 0.0);
</span>        
        <span class="ActionScriptDefault_Text">m_target</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SetV</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">def</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">target</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptComment">//m_localAnchor = b2MulT(m_bodyB.m_xf, m_target);
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_target</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_bodyB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_xf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_target</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_bodyB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_xf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tMat</span>:<span class="ActionScriptDefault_Text">b2Mat22</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bodyB</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_xf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">R</span>;
        <span class="ActionScriptDefault_Text">m_localAnchor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tX</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tY</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">m_localAnchor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tX</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tY</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptDefault_Text">m_maxForce</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">def</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">maxForce</span>;
        <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SetZero</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptDefault_Text">m_frequencyHz</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">def</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">frequencyHz</span>;
        <span class="ActionScriptDefault_Text">m_dampingRatio</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">def</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">dampingRatio</span>;
        
        <span class="ActionScriptDefault_Text">m_beta</span> <span class="ActionScriptOperator">=</span> 0.0;
        <span class="ActionScriptDefault_Text">m_gamma</span> <span class="ActionScriptOperator">=</span> 0.0;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptComment">// Presolve vars
</span>    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">K</span>:<span class="ActionScriptDefault_Text">b2Mat22</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Mat22</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">K1</span>:<span class="ActionScriptDefault_Text">b2Mat22</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Mat22</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">K2</span>:<span class="ActionScriptDefault_Text">b2Mat22</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Mat22</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">InitVelocityConstraints</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">step</span>:<span class="ActionScriptDefault_Text">b2TimeStep</span><span class="ActionScriptBracket/Brace">)</span>: <span class="ActionScriptReserved">void</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">b</span>:<span class="ActionScriptDefault_Text">b2Body</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bodyB</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">mass</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">GetMass</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">// Frequency
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">omega</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 2.0 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">PI</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_frequencyHz</span>;
        
        <span class="ActionScriptComment">// Damping co-efficient
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">d</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 2.0 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">mass</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_dampingRatio</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">omega</span>;
        
        <span class="ActionScriptComment">// Spring stiffness
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">k</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">mass</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">omega</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">omega</span>;
        
        <span class="ActionScriptComment">// magic formulas
</span>        <span class="ActionScriptComment">// gamma has units of inverse mass
</span>        <span class="ActionScriptComment">// beta hs units of inverse time
</span>        <span class="ActionScriptComment">//b2Settings.b2Assert(d + step.dt * k &gt; Number.MIN_VALUE)
</span>        <span class="ActionScriptDefault_Text">m_gamma</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">step</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">dt</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">step</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">dt</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">m_gamma</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_gamma</span> <span class="ActionScriptOperator">!=</span> 0 <span class="ActionScriptOperator">?</span> 1 <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">m_gamma</span>:0.0;
        <span class="ActionScriptDefault_Text">m_beta</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">step</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">dt</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_gamma</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tMat</span>:<span class="ActionScriptDefault_Text">b2Mat22</span>;
        
        <span class="ActionScriptComment">// Compute the effective mass matrix.
</span>        <span class="ActionScriptComment">//b2Vec2 r = b2Mul(b-&gt;m_xf.R, m_localAnchor - b-&gt;GetLocalCenter());
</span>        <span class="ActionScriptDefault_Text">tMat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_xf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">R</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_localAnchor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_sweep</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">localCenter</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_localAnchor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_sweep</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">localCenter</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">rY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tX</span>;
        
        <span class="ActionScriptComment">// K    = [(1/m1 + 1/m2) * eye(2) - skew(r1) * invI1 * skew(r1) - skew(r2) * invI2 * skew(r2)]
</span>        <span class="ActionScriptComment">//      = [1/m1+1/m2     0    ] + invI1 * [r1.y*r1.y -r1.x*r1.y] + invI2 * [r1.y*r1.y -r1.x*r1.y]
</span>        <span class="ActionScriptComment">//        [    0     1/m1+1/m2]           [-r1.x*r1.y r1.x*r1.x]           [-r1.x*r1.y r1.x*r1.x]
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">invMass</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_invMass</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">invI</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_invI</span>;
        
        <span class="ActionScriptComment">//b2Mat22 K1;
</span>        <span class="ActionScriptDefault_Text">K1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">invMass</span>;    <span class="ActionScriptDefault_Text">K1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> 0.0;
        <span class="ActionScriptDefault_Text">K1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> 0.0;        <span class="ActionScriptDefault_Text">K1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">invMass</span>;
        
        <span class="ActionScriptComment">//b2Mat22 K2;
</span>        <span class="ActionScriptDefault_Text">K2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span>  <span class="ActionScriptDefault_Text">invI</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span>;    <span class="ActionScriptDefault_Text">K2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">invI</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span>;
        <span class="ActionScriptDefault_Text">K2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">invI</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span>;    <span class="ActionScriptDefault_Text">K2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span>  <span class="ActionScriptDefault_Text">invI</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span>;
        
        <span class="ActionScriptComment">//b2Mat22 K = K1 + K2;
</span>        <span class="ActionScriptDefault_Text">K</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SetM</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">K1</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">K</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">AddM</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">K2</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">K</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">m_gamma</span>;
        <span class="ActionScriptDefault_Text">K</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">m_gamma</span>;
        
        <span class="ActionScriptComment">//m_ptpMass = K.GetInverse();
</span>        <span class="ActionScriptDefault_Text">K</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">GetInverse</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_mass</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">//m_C = b.m_position + r - m_target;
</span>        <span class="ActionScriptDefault_Text">m_C</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_sweep</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_target</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">m_C</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_sweep</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">rY</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">m_target</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        
        <span class="ActionScriptComment">// Cheat with some damping
</span>        <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_angularVelocity</span> <span class="ActionScriptOperator">*=</span> 0.98;
        
        <span class="ActionScriptComment">// Warm starting.
</span>        <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*=</span> <span class="ActionScriptDefault_Text">step</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">dtRatio</span>;
        <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*=</span> <span class="ActionScriptDefault_Text">step</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">dtRatio</span>;
        <span class="ActionScriptComment">//b.m_linearVelocity += invMass * m_impulse;
</span>        <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_linearVelocity</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">invMass</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_linearVelocity</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">invMass</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptComment">//b.m_angularVelocity += invI * b2Cross(r, m_impulse);
</span>        <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_angularVelocity</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">invI</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">rY</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">SolveVelocityConstraints</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">step</span>:<span class="ActionScriptDefault_Text">b2TimeStep</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span><span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">b</span>:<span class="ActionScriptDefault_Text">b2Body</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_bodyB</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tMat</span>:<span class="ActionScriptDefault_Text">b2Mat22</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tX</span>:<span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tY</span>:<span class="ActionScriptDefault_Text">Number</span>;
        
        <span class="ActionScriptComment">// Compute the effective mass matrix.
</span>        <span class="ActionScriptComment">//b2Vec2 r = b2Mul(b-&gt;m_xf.R, m_localAnchor - b-&gt;GetLocalCenter());
</span>        <span class="ActionScriptDefault_Text">tMat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_xf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">R</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_localAnchor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_sweep</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">localCenter</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_localAnchor</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_sweep</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">localCenter</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptDefault_Text">tX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">rY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tX</span>;
        
        <span class="ActionScriptComment">// Cdot = v + cross(w, r)
</span>        <span class="ActionScriptComment">//b2Vec2 Cdot = b-&gt;m_linearVelocity + b2Cross(b-&gt;m_angularVelocity, r);
</span>        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">CdotX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_linearVelocity</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_angularVelocity</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rY</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">CdotY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_linearVelocity</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_angularVelocity</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">rX</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptComment">//b2Vec2 impulse = - b2Mul(m_mass, Cdot + m_beta * m_C + m_gamma * m_impulse);
</span>        <span class="ActionScriptDefault_Text">tMat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_mass</span>;
        <span class="ActionScriptDefault_Text">tX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">CdotX</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">m_beta</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_C</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">m_gamma</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptDefault_Text">tY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">CdotY</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">m_beta</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_C</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">m_gamma</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">impulseX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">tX</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">tY</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">impulseY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">tX</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tMat</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">col2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">tY</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">oldImpulseX</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">oldImpulseY</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;
        <span class="ActionScriptComment">//m_impulse += impulse;
</span>        <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">impulseX</span>;
        <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">impulseY</span>;
        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">maxImpulse</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">step</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">dt</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">m_maxForce</span>;
        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">LengthSquared</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">maxImpulse</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">maxImpulse</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//m_impulse *= m_maxImpulse / m_impulse.Length();
</span>            <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Multiply</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxImpulse</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Length</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptComment">//impulse = m_impulse - oldImpulse;
</span>        <span class="ActionScriptDefault_Text">impulseX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">oldImpulseX</span>;
        <span class="ActionScriptDefault_Text">impulseY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">m_impulse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">oldImpulseY</span>;
        
        <span class="ActionScriptComment">//b-&gt;m_linearVelocity += b-&gt;m_invMass * impulse;
</span>        <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_linearVelocity</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_invMass</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">impulseX</span>;
        <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_linearVelocity</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_invMass</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">impulseY</span>;
        <span class="ActionScriptComment">//b-&gt;m_angularVelocity += b-&gt;m_invI * b2Cross(r, P);
</span>        <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_angularVelocity</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">m_invI</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rX</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">impulseY</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">rY</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">impulseX</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptDefault_Text">b2internal</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">SolvePositionConstraints</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">baumgarte</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptBracket/Brace">{</span> 
        <span class="ActionScriptComment">//B2_NOT_USED(baumgarte);
</span>        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>; 
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_localAnchor</span>:<span class="ActionScriptDefault_Text">b2Vec2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_target</span>:<span class="ActionScriptDefault_Text">b2Vec2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_impulse</span>:<span class="ActionScriptDefault_Text">b2Vec2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;

    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_mass</span>:<span class="ActionScriptDefault_Text">b2Mat22</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Mat22</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;    <span class="ActionScriptComment">// effective mass for point-to-point constraint.
</span>    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_C</span>:<span class="ActionScriptDefault_Text">b2Vec2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">b2Vec2</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptComment">// position error
</span>    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_maxForce</span>:<span class="ActionScriptDefault_Text">Number</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_frequencyHz</span>:<span class="ActionScriptDefault_Text">Number</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_dampingRatio</span>:<span class="ActionScriptDefault_Text">Number</span>;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_beta</span>:<span class="ActionScriptDefault_Text">Number</span>;                        <span class="ActionScriptComment">// bias factor
</span>    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">m_gamma</span>:<span class="ActionScriptDefault_Text">Number</span>;                        <span class="ActionScriptComment">// softness
</span><span class="ActionScriptBracket/Brace">}</span>;

<span class="ActionScriptBracket/Brace">}</span>
</pre></body>
</html>
